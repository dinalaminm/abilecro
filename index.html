<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶ø‡¶ï - ‡¶¨‡¶ø‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary-blue: #007BFF;
            --primary-green: #28A745;
            --primary-gradient: linear-gradient(135deg, #42a5f5 0%, #30cfd0 100%);
            --background-start: #E0F7FA;
            --background-end: #B2EBF2;
            --white-color: #FFFFFF;
            --text-dark: #1E293B;
            --text-light: #64748B;
            --border-color: rgba(255, 255, 255, 0.4);
            --danger-red: #EF4444;
            --danger-red-dark: #B91C1C;
            --success-green: #10B981;
            --glass-bg: rgba(255, 255, 255, 0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-image: linear-gradient(to bottom right, var(--background-start), var(--background-end));
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-top: 80px; /* Navbar height + margin */
            padding-bottom: 95px; /* Bottom Nav height + margin */
            min-height: 100vh;
        }

        /* --- ‡¶ó‡ßç‡¶≤‡¶æ‡∏™‡∏°‡¶∞‡¶´‡¶ø‡¶ú‡¶Æ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 24px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            padding: 25px;
        }

        /* --- ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡ßá‡¶ú ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ --- */
        #auth-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            padding-top: 0;
        }
        .auth-container {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .auth-header {
            margin-bottom: 30px;
        }
        .auth-header .company-logo {
            width: 70px;
            height: 70px;
            background: var(--white-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .auth-title {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .auth-subtitle {
            font-size: 15px;
            color: var(--text-light);
            margin-top: 5px;
        }
        .auth-form .form-group {
            margin-bottom: 20px;
        }
        .auth-form input {
            width: 100%;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            transition: all .3s ease;
        }
        .auth-form input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2);
        }
        .auth-btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: var(--primary-gradient);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
        }
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
        }
        .auth-toggle {
            text-align: center;
            margin-top: 25px;
            font-size: 14px;
            color: var(--text-light);
        }
        .auth-toggle a {
            color: var(--primary-blue);
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }
        #auth-error-message {
            color: var(--danger-red);
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        /* --- ‡¶®‡ßç‡¶Ø‡¶æ‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶∞ --- */
        .navbar {
            position: fixed;
            top: 15px;
            left: 15px;
            right: 15px;
            height: 55px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-dark);
            z-index: 1001;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }
        .navbar.hidden { transform: translateY(-120%); }

        .nav-container {
            display: flex;
            align-items: center;
            height: 100%;
            padding: 0 15px;
        }
        .nav-logo {
            height: 36px;
            border-radius: 8px;
            margin-right: 10px;
        }
        .nav-title {
            font-size: 17px;
            font-weight: 600;
            margin: 0;
            flex-grow: 1;
        }
        .menu-btn {
            font-size: 24px;
            cursor: pointer;
            padding-right: 15px;
        }

        .container {
            max-width: 900px;
            margin: auto;
            padding: 0 15px;
        }

        /* --- ‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ --- */
        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1002;
            top: 0;
            left: 0;
            background-color: var(--white-color);
            overflow-x: hidden;
            transition: 0.5s;
            box-shadow: 3px 0 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .sidenav .sidenav-header {
            padding: 20px 25px;
            font-size: 22px;
            font-weight: 600;
            color: var(--white-color);
            background: var(--primary-gradient);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidenav a {
            padding: 15px 15px 15px 32px;
            text-decoration: none;
            font-size: 17px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: 0.3s;
            border-left: 4px solid transparent;
        }
        .sidenav a svg {
            width: 22px;
            height: 22px;
            stroke-width: 2;
            color: var(--text-light);
            transition: color 0.3s;
        }
        .sidenav a:hover {
            background-color: #f0f8ff;
            color: var(--primary-blue);
            border-left-color: var(--primary-blue);
        }
        .sidenav a:hover svg { color: var(--primary-blue); }
        .sidenav .close-btn {
            position: static;
            font-size: 32px;
            color: var(--white-color);
            text-decoration: none;
            border-left: none;
            padding: 0;
            line-height: 1;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        .sidenav .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-left-color: transparent;
            color: var(--white-color);
        }
        .sidenav-divider {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin: 10px 25px;
        }
        .sidenav-footer {
            margin-top: auto;
            padding: 20px 32px;
            font-size: 13px;
            color: var(--text-light);
        }

        #main-content, #history-page, #shop-page, #home-page, .bottom-nav, .fab-add {
            transition: filter 0.5s ease-out;
        }
        .content-blur {
            filter: blur(5px);
            pointer-events: none;
        }

        /* --- ‡¶π‡ßã‡¶Æ ‡¶™‡ßá‡¶ú ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ --- */
        #home-page { display: block; }
        .home-header { margin-bottom: 25px; }
        .home-greeting h2 { font-size: 24px; font-weight: 700; }
        .home-greeting p { color: var(--text-light); font-size: 16px; }
        .search-bar {
            width: 100%;
            padding: 14px 20px;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            font-size: 16px;
            margin-top: 15px;
        }
        .search-bar:focus {
             outline: none;
             box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-left: 5px;
        }
        .featured-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .featured-card {
            background: var(--white-color);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .featured-card h3 { font-size: 18px; margin-bottom: 5px; }
        .featured-card p { font-size: 14px; color: var(--text-light); margin-bottom: 15px; }
        .stat-number { font-size: 28px; font-weight: 700; color: var(--primary-blue); }

        /* --- ‡¶´‡¶∞‡ßç‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ --- */
        input[type="text"], input[type="number"], input[type="date"], input[type="email"], input[type="password"], select {
            width: 100%;
            padding: 14px 20px;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            transition: all .3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2);
        }
        .customer-info{ display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px }
        .full-width { grid-column: 1 / -1; }
        .date-field label {
            font-weight: 500; color: var(--text-dark); margin-bottom: 8px;
            display: block; font-size: 14px; padding-left: 10px;
        }

        .table-wrapper{
            overflow-x:auto; background: var(--glass-bg);
            border: 1px solid var(--border-color); padding: 15px; border-radius: 20px;
        }
        table{ width:100%; border-collapse:collapse; }
        th,td{ padding:14px 10px; text-align:center; border-bottom:1px solid var(--border-color); vertical-align:middle; }
        
        #bill-table th:nth-child(1), #bill-table td:nth-child(1) { width: 5%; } /* ‡¶®‡¶Ç */
        #bill-table th:nth-child(2), #bill-table td:nth-child(2) { width: 40%; text-align: left; min-width: 200px; } /* ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ */
        #bill-table th:nth-child(3), #bill-table td:nth-child(3) { width: 15%; text-align: right; } /* ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ */
        #bill-table th:nth-child(4), #bill-table td:nth-child(4) { width: 15%; text-align: right; } /* ‡¶¶‡¶∞ */
        #bill-table th:nth-child(5), #bill-table td:nth-child(5) { width: 20%; text-align: right; } /* ‡¶ü‡¶æ‡¶ï‡¶æ */
        #bill-table th:nth-child(6), #bill-table td:nth-child(6) { width: 5%; } /* ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶® */

        th{ 
            background-color: rgba(0, 123, 255, 0.1);
            color: var(--text-dark); 
            font-weight:600; 
            font-size:14px; 
            letter-spacing:.5px; 
            text-transform:uppercase; 
            border-bottom-width: 2px; 
        }
        tr:last-child td{ border-bottom:none }
        
        td input {
            background: transparent;
            border: none;
            text-align: inherit;
            width: 100%;
            padding: 5px;
            font-family: inherit;
            font-size: inherit;
            line-height: 1.4;
            box-sizing: border-box;
        }
        td input.quantity, td input.price {
            width: auto; 
            min-width: 8ch;
            font-size: 16px;
            padding: 8px 5px;
        }
        td input.product-name {
             width: auto;
            min-width: 15ch;
        }
        #bill-table td.amount {
            font-weight: 600;
            color: var(--text-dark);
        }
        td input:focus {
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            outline: none;
        }

        .btn{
            padding: 12px 24px; border: none; border-radius: 16px;
            cursor: pointer; font-size: 16px; font-family: 'Poppins', sans-serif;
            transition: all .3s ease; font-weight: 600;
        }
        .btn-add{
            color: white; background: var(--primary-gradient);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
        }
        .btn-remove{
            background:transparent; color: var(--danger-red);
            font-size: 20px; padding: 5px;
        }
        .btn-delete {
            background-image: linear-gradient(to right, var(--danger-red) 0%, var(--danger-red-dark) 51%, var(--danger-red) 100%);
            color: white;
        }
        .btn-print {
            display:block; width:100%; margin-top:20px; padding:16px; font-size:18px;
        }

        .totals-container{ margin-top: 20px; padding: 20px; }
        .totals-table td{ border:none; padding:10px; font-size:16px; }
        .text-right{ text-align:right!important; font-weight:700 }
        #advance {
             text-align:right; width: 120px; padding: 8px 12px; border-radius: 12px;
        }

        /* --- ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶™‡ßá‡¶ú --- */
        #history-list { list-style: none; padding: 0; display: grid; gap: 15px; }
        .date-history-item, .memo-list-item {
            background: var(--glass-bg); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 15px 20px; display: flex;
            justify-content: space-between; align-items: center;
            transition: all 0.3s ease;
        }
        .date-history-item { cursor: pointer; }
        .date-history-item:hover {
             transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }
        .memo-list-item { flex-wrap: wrap; gap: 10px; }
        .memo-list-item .controls button { margin-left: 5px; padding: 8px 14px; font-size: 14px; }

        /* --- ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶∂‡¶™ ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® --- */
        .custom-dropdown { position: relative; width: 100%; margin-bottom: 20px; }
        .custom-dropdown-select {
            width: 100%; padding: 14px 20px; background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-color); border-radius: 16px; font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: space-between;
        }
        .custom-dropdown-options {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #e2e8f0; border-radius: 12px;
            margin-top: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 1000;
            max-height: 300px; overflow-y: auto; display: none;
        }
        .custom-dropdown.selected .custom-dropdown-options { display: block; }
        .custom-dropdown-option {
            padding: 12px 16px; display: flex; align-items: center; gap: 12px;
            cursor: pointer; transition: background-color 0.3s ease; border-bottom: 1px solid #e2e8f0;
        }
        .custom-dropdown-option:last-child { border-bottom: none; }
        .custom-dropdown-option:hover { background: #f0f8ff; }
        .custom-dropdown-option-logo { width: 30px; height: 30px; border-radius: 6px; object-fit: cover; }
        .custom-dropdown-chevron { transition: transform 0.3s ease; }
        .custom-dropdown.selected .custom-dropdown-chevron { transform: rotate(180deg); }


        /* --- ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶™‡ßá‡¶ú --- */
        .shop-list { display: grid; gap: 15px; margin-top: 20px;}
        .shop-item {
            display: flex; align-items: center; gap: 15px;
        }
        .shop-item-logo { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; }
        .shop-item-info { flex-grow: 1; }
        .shop-item-name { font-size: 18px; font-weight: 600; }
        .shop-item-details { font-size: 14px; color: var(--text-light); }
        .shop-item-actions button { font-size: 14px; padding: 8px 12px; border-radius: 12px; }

        /* --- Floating Action Button --- */
        .fab-add {
            position: fixed; bottom: 100px; right: 25px;
            width: 60px; height: 60px;
            background: var(--primary-gradient);
            color: white; border: none; border-radius: 50%;
            font-size: 30px; line-height: 60px; text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            cursor: pointer; z-index: 1000; transition: all 0.3s ease;
        }
        .fab-add:hover { transform: scale(1.05); }


        /* --- ‡¶¨‡¶ü‡¶Æ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® --- */
        .bottom-nav {
            position: fixed; bottom: 15px; left: 15px; right: 15px; height: 65px;
            background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); z-index: 999;
            border-radius: 20px; border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }
        .bottom-nav.hidden { transform: translateY(120%); }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-light); text-decoration: none; font-size: 12px;
            font-weight: 500; gap: 4px; transition: color 0.3s;
        }
        .nav-item svg { width: 24px; height: 24px; transition: all 0.3s ease; }
        .nav-item.active { color: var(--primary-blue); font-weight: 600; }
        .nav-item.active svg { transform: scale(1.1); }

        /* --- ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø --- */
        .main-app-container { display: none; }
        .modal {
            display:none; position:fixed; z-index:2000; left:0; top:0;
            width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,.5)
        }
        .modal-content{
            background-color:#fefefe; margin:10% auto; padding:25px;
            border:1px solid #888; width:90%; max-width:500px; border-radius:24px;
        }
        .modal-header {
            display:flex; justify-content:space-between; align-items:center;
            border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 15px;
        }
        .modal-close-btn{ font-size:28px; font-weight:bold; cursor:pointer; }
        .shop-edit-form label {
            display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 500;
        }
        .empty-state-container { padding: 80px 20px; text-align: center; }
        .empty-state-title { font-size: 22px; font-weight: 600; }
        .empty-state-subtitle { font-size: 16px; color: var(--text-light); }
         @media print {
            .navbar, .sidenav, .bottom-nav, .fab-add, #preview-page .header-bar { display: none !important; }
            #main-content, #history-page, #shop-page, #home-page { display: none !important; }
            #preview-page { display: block !important; visibility: visible !important; }
            body, html { margin: 0 !important; padding: 0 !important; background: #fff !important; }
            #preview-page .container { box-shadow: none !important; border: none !important; margin: 0 !important; padding: 0 !important; max-width: 100% !important; width: 100% !important; border-radius: 0 !important; }
            #memo-content-for-print { border: none !important; padding: 0 !important; }
        }
    </style>
</head>
<body>

    <!-- ‡¶Ö‡¶•‡ßá‡¶®‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶™‡ßá‡¶ú -->
    <div id="auth-page">
        <div class="auth-container glass-card">
            <!-- Login Form -->
            <div id="login-form">
                <div class="auth-header">
                    <div class="company-logo">üíô</div>
                    <h1 class="auth-title">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!</h1>
                    <p class="auth-subtitle">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                </div>
                <form class="auth-form" onsubmit="handleSignIn(event)">
                    <p id="auth-error-message"></p>
                    <div class="form-group">
                        <input type="email" id="login-email" required placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤">
                    </div>
                    <div class="form-group">
                        <input type="password" id="login-password" required placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
                    </div>
                    <button type="submit" class="auth-btn">‡¶≤‡¶ó‡¶á‡¶®</button>
                </form>
                <div class="auth-toggle">
                    ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? <a onclick="toggleAuthForms()">‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</a>
                </div>
            </div>

            <!-- Registration Form -->
            <div id="register-form" style="display: none;">
                 <div class="auth-header">
                    <div class="company-logo">üíô</div>
                    <h1 class="auth-title">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h1>
                    <p class="auth-subtitle">‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®</p>
                </div>
                <form class="auth-form" onsubmit="handleSignUp(event)">
                    <div class="form-group">
                        <input type="email" id="register-email" required placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤">
                    </div>
                    <div class="form-group">
                        <input type="password" id="register-password" required minlength="6" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
                    </div>
                    <button type="submit" class="auth-btn">‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶®</button>
                </form>
                <div class="auth-toggle">
                    ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <a onclick="toggleAuthForms()">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</a>
                </div>
            </div>
        </div>
    </div>


    <!-- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
    <div class="main-app-container">
        <!-- ‡¶®‡ßç‡¶Ø‡¶æ‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶∞ -->
        <div class="navbar" id="navbar">
            <div class="nav-container">
                <span class="menu-btn" onclick="openNav()">&#9776;</span>
                <img src="https://i.ibb.co.com/B9LFnxY/20251109-143256.png" alt="Shop Logo" class="nav-logo" id="nav-logo">
                <h1 class="nav-title" id="nav-title">‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶ø‡¶ï</h1>
            </div>
        </div>
        
        <div id="mySidenav" class="sidenav">
            <div class="sidenav-header">
                <span>‡¶Æ‡ßá‡¶®‡ßÅ</span>
                <a href="javascript:void(0)" class="close-btn" onclick="closeNav()">&times;</a>
            </div>
            <a href="#" id="side-home-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span>‡¶π‡ßã‡¶Æ</span></a>
            <a href="#" id="side-new-memo-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg><span>‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßá‡¶Æ‡ßã</span></a>
            <a href="#" id="side-show-history-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</span></a>
            <hr class="sidenav-divider">
            <a href="#" id="side-shop-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg><span>‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®</span></a>
            <a href="#" id="side-privacy-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg><span>‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø</span></a>
            <a href="#" id="side-logout-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg><span>‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</span></a>
            <div class="sidenav-footer">‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶∞‡¶£ ‡ßß.‡ßß‡ßÆ</div>
        </div>

        <!-- ‡¶π‡ßã‡¶Æ ‡¶™‡ßá‡¶ú -->
        <div id="home-page" class="container">
            <div class="home-header glass-card">
                 <div class="home-greeting">
                     <h2 id="home-greeting-title">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!</h2>
                     <p id="home-greeting-subtitle">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶≤ ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                 </div>
                 <input type="text" class="search-bar" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
            </div>

            <div style="margin-top: 25px;">
                <h2 class="section-title">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</h2>
                <div class="featured-cards" id="home-stats">
                     <div class="featured-card">
                        <h3>‡¶Æ‡ßã‡¶ü ‡¶Æ‡ßá‡¶Æ‡ßã</h3>
                        <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ø‡¶≤‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</p>
                        <div class="stat-number">0</div>
                    </div>
                     <div class="featured-card">
                        <h3>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü</h3>
                        <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</p>
                        <div class="stat-number">‡ß≥0.00</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="preview-page" style="display: none;">
            <!-- ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶ú‡¶æ‡¶≠‡¶æ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶¶‡¶ø‡ßü‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶¨‡ßá -->
        </div>

        <!-- ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶™‡ßá‡¶ú -->
        <div id="main-content" style="display: none;" class="container">
            <div class="glass-card">
                 <h2 class="section-title">‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                 
                 <div class="custom-dropdown" id="shop-custom-dropdown">
                    <div class="custom-dropdown-select" id="shop-dropdown-select">
                        <div id="selected-shop-text">‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®...</div>
                        <svg class="custom-dropdown-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>
                    <div class="custom-dropdown-options" id="shop-dropdown-options"></div>
                 </div>

                 <div class="customer-info">
                    <input type="text" id="memo-no" placeholder="‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Ç">
                    <input type="text" id="customer-name" placeholder="‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ">
                    <input type="text" id="customer-address" placeholder="‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" class="full-width">
                    <div class="date-field">
                        <label for="transaction-date">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="transaction-date" title="‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ">
                    </div>
                    <div class="date-field">
                        <label for="delivery-date">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="delivery-date" title="‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ">
                    </div>
                </div>
            </div>

             <div class="glass-card" style="margin-top: 20px;">
                <div class="table-wrapper">
                    <table id="bill-table">
                        <thead>
                            <tr><th>‡¶®‡¶Ç</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th><th>‡¶¶‡¶∞</th><th>‡¶ü‡¶æ‡¶ï‡¶æ</th><th>‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button class="btn btn-add" onclick="addRow()" style="margin-top: 15px;">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø</button>
            </div>

            <div class="totals-container glass-card">
                <table class="totals-table">
                    <tbody>
                        <tr><td>‡¶Æ‡ßã‡¶ü</td><td class="text-right" id="grand-total">0.00</td></tr>
                        <tr><td>‡¶Ö‡¶ó‡ßç‡¶∞‡¶ø‡¶Æ</td><td><input type="number" id="advance" value="0" min="0" oninput="calculateTotals()"></td></tr>
                        <tr><td><strong>‡¶¨‡¶æ‡¶ï‡¶ø</strong></td><td class="text-right" id="due"><strong>0.00</strong></td></tr>
                    </tbody>
                </table>
            </div>
            <button class="btn btn-add btn-print" id="print-save-btn" onclick="saveAndShowPreview()">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â</button>
        </div>

        <!-- ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶™‡ßá‡¶ú -->
        <div id="history-page" style="display: none;" class="container">
            <div class="glass-card">
                <h2 class="section-title" id="history-page-title">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
                <div class="custom-dropdown" id="history-custom-dropdown">
                    <div class="custom-dropdown-select" id="history-dropdown-select">
                        <div id="selected-history-shop-text">‡¶∏‡¶ï‡¶≤ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®</div>
                        <svg class="custom-dropdown-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>
                    <div class="custom-dropdown-options" id="history-dropdown-options"></div>
                 </div>
            </div>
            <ul id="history-list" style="margin-top: 20px;"></ul>
            <button class="fab-add" id="fab-add-memo">+</button>
        </div>

        <!-- ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶™‡ßá‡¶ú -->
        <div id="shop-page" style="display: none;" class="container">
             <div class="glass-card">
                 <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="section-title" style="margin: 0;">‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h2>
                    <button class="btn btn-add" onclick="openAddShopModal()">+ ‡¶®‡¶§‡ßÅ‡¶®</button>
                 </div>
            </div>
            <div id="shop-list-container" class="shop-list">
                <!-- ‡¶∂‡¶™‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá -->
            </div>
        </div>
        
        <!-- ‡¶¨‡¶ü‡¶Æ ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® -->
        <div class="bottom-nav">
            <a href="#" class="nav-item active" id="bottom-nav-home"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span>‡¶π‡ßã‡¶Æ</span></a>
            <a href="#" class="nav-item" id="bottom-nav-memo"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg><span>‡¶Æ‡ßá‡¶Æ‡ßã</span></a>
            <a href="#" class="nav-item" id="bottom-nav-history"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</span></a>
            <a href="#" class="nav-item" id="bottom-nav-shop"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg><span>‡¶¶‡ßã‡¶ï‡¶æ‡¶®</span></a>
        </div>
    </div>

    <!-- Modals -->
    <div id="shopEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="shop-modal-title">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <span class="modal-close-btn" id="shop-edit-modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <div class="shop-edit-form">
                    <label for="shop-name-input">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="shop-name-input" placeholder="‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶ø‡¶ï ‡¶è‡¶®‡ßç‡¶° ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏">
                    <label for="proprietor-name-input">‡¶™‡ßç‡¶∞‡ßã‡¶É ‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="proprietor-name-input" placeholder="‡¶Æ‡ßã‡¶É ‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶Æ‡ßã‡¶≤‡ßç‡¶≤‡¶æ">
                    <label for="shop-details1-input">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</label>
                    <input type="text" id="shop-details1-input" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï ‡¶ì ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ...">
                    <label for="shop-contact-input">‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó</label>
                    <input type="text" id="shop-contact-input" placeholder="‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó: ‡ß¶‡ßß‡ß©‡ß®‡ß¨-‡ßß‡ß≠‡ß¶‡ß≠‡ß≠‡ß≠">
                    <label for="shop-logo-input">‡¶≤‡ßã‡¶ó‡ßã URL</label>
                    <input type="text" id="shop-logo-input" placeholder="https://i.ibb.co/...">
                    <button class="btn btn-add" id="save-shop-info-btn" style="width: 100%; margin-top: 20px;">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>
        </div>
    </div>

    <div id="privacyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø (Privacy Policy)</h2>
                <span class="modal-close-btn" id="privacy-modal-close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p>‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ‡¶ï‡ßá ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶æ‡¶® ‡¶ï‡¶∞‡¶ø‡•§ ‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶¶‡¶æ‡ßü‡¶ø‡¶§‡ßç‡¶¨‡•§</p>
                <h3>‡¶ï‡ßã‡¶® ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º?</h3>
                <p>‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶Ö‡¶ß‡ßÄ‡¶®‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶¨‡¶ø‡¶≤‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßá‡•§</p>
                <h3>‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º?</h3>
                <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶¨‡¶ø‡¶≤‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡ßü‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡•§ ‡¶è‡¶á ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø ‡¶¨‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü ‡¶®‡¶æ‡•§</p>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAUjV_tUlWb5S7A8HSoTcU3vjvbuPzjtvI",
            authDomain: "app-1-e0ede.firebaseapp.com",
            databaseURL: "https://app-1-e0ede-default-rtdb.firebaseio.com",
            projectId: "app-1-e0ede",
            storageBucket: "app-1-e0ede.firebasestorage.app",
            messagingSenderId: "679519684721",
            appId: "1:679519684721:web:56b78c83b7fc66c30c73d0"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        let currentUserId = null;
        let currentlyEditing = null;
        let selectedShopId = null;
        let shops = {};

        const authPage = document.getElementById('auth-page');
        const mainAppContainer = document.querySelector('.main-app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authErrorMessage = document.getElementById('auth-error-message');

        function toggleAuthForms() {
            authErrorMessage.style.display = 'none';
            loginForm.style.display = loginForm.style.display === 'none' ? 'block' : 'none';
            registerForm.style.display = registerForm.style.display === 'none' ? 'block' : 'none';
        }

        function handleSignUp(event) {
            event.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            auth.createUserWithEmailAndPassword(email, password).catch(error => {
                authErrorMessage.textContent = error.message;
                authErrorMessage.style.display = 'block';
            });
        }

        function handleSignIn(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password).catch(error => {
                let message = "‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶ò‡¶ü‡ßá‡¶õ‡ßá‡•§";
                if (error.code === 'auth/user-not-found') message = "‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§";
                else if (error.code === 'auth/wrong-password') message = "‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                authErrorMessage.textContent = message;
                authErrorMessage.style.display = 'block';
            });
        }

        function handleSignOut() {
            auth.signOut().catch(error => console.error("Sign out error:", error));
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                authPage.style.display = 'none';
                document.body.style.paddingTop = '80px';
                mainAppContainer.style.display = 'block';
                initializeApp();
            } else {
                currentUserId = null;
                authPage.style.display = 'flex';
                document.body.style.paddingTop = '0';
                mainAppContainer.style.display = 'none';
            }
        });

        function initializeApp() {
            initializeCustomDropdowns();
            fetchShops();
            resetForm(); 
            showHomeDashboard();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transaction-date').value = today;
            document.getElementById('delivery-date').value = today;
            addRow();
        }
        
        let lastScrollTop = 0;
        const navbar = document.getElementById('navbar');
        const bottomNav = document.querySelector('.bottom-nav');
        window.addEventListener('scroll', function() {
            let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if (scrollTop > lastScrollTop && scrollTop > 50) {
                navbar.classList.add('hidden');
                bottomNav.classList.add('hidden');
            } else {
                navbar.classList.remove('hidden');
                bottomNav.classList.remove('hidden');
            }
            lastScrollTop = scrollTop;
        });

        const mainContent = document.getElementById('main-content');
        const historyPage = document.getElementById('history-page');
        const shopPage = document.getElementById('shop-page');
        const homePage = document.getElementById('home-page');
        const previewPage = document.getElementById('preview-page');

        function showHomeDashboard() {
            homePage.style.display = 'block'; mainContent.style.display = 'none';
            historyPage.style.display = 'none'; shopPage.style.display = 'none';
            previewPage.style.display = 'none'; handleActiveNav('bottom-nav-home');
            loadHomeStats();
        }
        
        function showMemoPage() {
            homePage.style.display = 'none'; mainContent.style.display = 'block';
            historyPage.style.display = 'none'; shopPage.style.display = 'none';
            previewPage.style.display = 'none'; handleActiveNav('bottom-nav-memo');
        }
        
        function showHistoryPage(showFabButton = true) {
            homePage.style.display = 'none'; mainContent.style.display = 'none';
            historyPage.style.display = 'block'; shopPage.style.display = 'none';
            previewPage.style.display = 'none';
            document.getElementById('fab-add-memo').style.display = showFabButton ? 'block' : 'none';
            historyView = 'dates'; selectedHistoryDate = null;
            displayHistory(); handleActiveNav('bottom-nav-history');
        }
        
        function showShopPage() {
            homePage.style.display = 'none'; mainContent.style.display = 'none';
            historyPage.style.display = 'none'; shopPage.style.display = 'block';
            previewPage.style.display = 'none'; handleActiveNav('bottom-nav-shop');
            loadShopList();
        }

        function handleActiveNav(activeId){
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(activeId).classList.add('active');
        }

        function openNav() {
            document.getElementById("mySidenav").style.width = "280px";
            document.querySelectorAll('#main-content, #history-page, #shop-page, #home-page, #preview-page, .bottom-nav, .fab-add').forEach(el => el.classList.add('content-blur'));
        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
            document.querySelectorAll('.content-blur').forEach(el => el.classList.remove('content-blur'));
        }

        function loadHomeStats() {
            if (!currentUserId) return;
            const statsContainer = document.getElementById('home-stats');
            if (!statsContainer) return;
            
            const memosRef = database.ref(`users/${currentUserId}/memos`);
            memosRef.once('value').then((snapshot) => {
                let totalMemos = 0, totalRevenue = 0;
                if (snapshot.exists()) {
                    snapshot.forEach(dateSnapshot => {
                        const memosOnDate = dateSnapshot.val();
                        totalMemos += Object.keys(memosOnDate).length;
                        for (const key in memosOnDate) {
                            totalRevenue += parseFloat(memosOnDate[key].grandTotal || 0);
                        }
                    });
                }
                statsContainer.innerHTML = `
                    <div class="featured-card"><h3>‡¶Æ‡ßã‡¶ü ‡¶Æ‡ßá‡¶Æ‡ßã</h3><p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ø‡¶≤‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</p><div class="stat-number">${totalMemos}</div></div>
                    <div class="featured-card"><h3>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü</h3><p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</p><div class="stat-number">‡ß≥${totalRevenue.toLocaleString('bn-BD', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div></div>`;
            }).catch(error => console.error("Error loading stats:", error));
        }

        function initializeCustomDropdowns() {
            ['shop', 'history'].forEach(type => {
                const dropdown = document.getElementById(`${type}-custom-dropdown`);
                const select = document.getElementById(`${type}-dropdown-select`);
                if(dropdown && select) {
                    select.addEventListener('click', e => {
                        e.stopPropagation();
                        dropdown.classList.toggle('selected');
                    });
                }
            });
            document.addEventListener('click', () => {
                document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.remove('selected'));
            });
        }
        
        function fetchShops() {
            if (!currentUserId) return;
            const shopsRef = database.ref(`users/${currentUserId}/shops`);
            shopsRef.on('value', (snapshot) => {
                shops = snapshot.exists() ? snapshot.val() : {};
                if (!selectedShopId && Object.keys(shops).length > 0) {
                    selectedShopId = Object.keys(shops)[0];
                }
                updateCustomDropdowns();
                updateUIWithShopInfo();
                
            });
        }

        function updateCustomDropdowns() {
            ['shop', 'history'].forEach(type => {
                const optionsContainer = document.getElementById(`${type}-dropdown-options`);
                const selectedText = document.getElementById(`selected-${type === 'shop' ? '' : 'history-'}shop-text`);
                if (!optionsContainer || !selectedText) return;

                optionsContainer.innerHTML = '';
                
                if (type === 'history') {
                    const allOption = document.createElement('div');
                    allOption.className = 'custom-dropdown-option';
                    allOption.innerHTML = `<div>‡¶∏‡¶ï‡¶≤ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®</div>`;
                    allOption.onclick = () => {
                        selectedShopId = null;
                        selectedText.textContent = '‡¶∏‡¶ï‡¶≤ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®';
                        document.getElementById('history-custom-dropdown').classList.remove('selected');
                        displayHistory();
                    };
                    optionsContainer.appendChild(allOption);
                }

                for (const shopId in shops) {
                    const shop = shops[shopId];
                    const option = document.createElement('div');
                    option.className = 'custom-dropdown-option';
                    option.innerHTML = `<img src="${shop.logoUrl}" alt="" class="custom-dropdown-option-logo"><div>${shop.name}</div>`;
                    option.onclick = () => {
                        selectedShopId = shopId;
                        selectedText.textContent = shop.name;
                        document.getElementById(`${type}-custom-dropdown`).classList.remove('selected');
                        if (type === 'shop') updateUIWithShopInfo();
                        else displayHistory();
                    };
                    optionsContainer.appendChild(option);
                }

                if (type === 'shop') {
                    selectedText.textContent = (selectedShopId && shops[selectedShopId]) ? shops[selectedShopId].name : '‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®...';
                }
            });
        }
        
        function updateUIWithShopInfo() {
            const navLogo = document.getElementById('nav-logo');
            const navTitle = document.getElementById('nav-title');
            if (selectedShopId && shops[selectedShopId]) {
                const shop = shops[selectedShopId];
                navLogo.src = shop.logoUrl;
                navTitle.innerText = shop.name;
            } else {
                navLogo.src = "https://i.ibb.co/fYwdd8h/IMG-20251107-WA0006.jpg";
                navTitle.innerText = "‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶ø‡¶ï";
            }
        }

        function loadShopList() {
            const container = document.getElementById('shop-list-container');
            if (!container) return;
            container.innerHTML = '';

            if (Object.keys(shops).length === 0) {
                container.innerHTML = `<div class="empty-state-container"><h2 class="empty-state-title">‡¶ï‡ßã‡¶® ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶®‡ßá‡¶á</h2><p class="empty-state-subtitle">‡¶®‡¶§‡ßÅ‡¶® ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</p></div>`;
                return;
            }
            
            for (const shopId in shops) {
                const shop = shops[shopId];
                const item = document.createElement('div');
                item.className = 'shop-item glass-card';
                item.innerHTML = `
                    <img src="${shop.logoUrl}" alt="${shop.name}" class="shop-item-logo">
                    <div class="shop-item-info">
                        <h3 class="shop-item-name">${shop.name}</h3>
                        <p class="shop-item-details">${shop.proprietor}</p>
                    </div>
                    <div class="shop-item-actions">
                        <button class="btn" style="background: #f0f8ff; color: #007BFF;" onclick="editShop('${shopId}')">‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</button>
                        <button class="btn btn-delete" onclick="deleteShop('${shopId}')">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                    </div>`;
                container.appendChild(item);
            }
        }

        function openAddShopModal() {
            document.getElementById('shop-modal-title').textContent = '‡¶®‡¶§‡ßÅ‡¶® ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®';
            ['shop-name-input', 'proprietor-name-input', 'shop-details1-input', 'shop-contact-input', 'shop-logo-input'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('save-shop-info-btn').removeAttribute('data-shop-id');
            document.getElementById('shopEditModal').style.display = 'block';
        }

        function editShop(shopId) {
            const shop = shops[shopId];
            document.getElementById('shop-modal-title').textContent = '‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®';
            document.getElementById('shop-name-input').value = shop.name || '';
            document.getElementById('proprietor-name-input').value = shop.proprietor || '';
            document.getElementById('shop-details1-input').value = shop.details1 || '';
            document.getElementById('shop-contact-input').value = shop.contact || '';
            document.getElementById('shop-logo-input').value = shop.logoUrl || '';
            document.getElementById('save-shop-info-btn').setAttribute('data-shop-id', shopId);
            document.getElementById('shopEditModal').style.display = 'block';
        }

        function deleteShop(shopId) {
            if (!currentUserId || !confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶á ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶Æ‡ßá‡¶Æ‡ßã‡¶ì ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§')) return;
            
            const memosRef = database.ref(`users/${currentUserId}/memos`);
            memosRef.once('value').then((snapshot) => {
                const updates = {};
                if (snapshot.exists()) {
                    snapshot.forEach(dateSnapshot => {
                        dateSnapshot.forEach(memoSnapshot => {
                            if (memoSnapshot.val().shopId === shopId) {
                                updates[`users/${currentUserId}/memos/${dateSnapshot.key}/${memoSnapshot.key}`] = null;
                            }
                        });
                    });
                }
                updates[`users/${currentUserId}/shops/${shopId}`] = null;
                return database.ref().update(updates);
            }).then(() => {
                alert('‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
                if (selectedShopId === shopId) selectedShopId = Object.keys(shops)[0] || null;
            }).catch(error => alert('‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø: ' + error.message));
        }

        function updateSerialNumbers(){ document.querySelectorAll('#bill-table tbody tr').forEach((r, i) => r.cells[0].textContent = i + 1); }
        
        function calculateRow(el){
            let row = el.closest('tr');
            let qty = parseFloat(row.querySelector('.quantity').value) || 0;
            let price = parseFloat(row.querySelector('.price').value) || 0;
            row.querySelector('.amount').innerText = (qty * price).toFixed(2);
            calculateTotals();
        }
        
        function autoResizeInputWidth(input) {
            const minChars = 3; 
            const newSize = Math.max(input.value.length, minChars);
            input.style.width = (newSize + 2) + 'ch';
        }
        
        function autoResizeDescriptionWidth(input) {
            const minWidthChars = 15;
            const newSize = Math.max(input.value.length, minWidthChars);
            input.style.width = (newSize + 2) + 'ch';
        }

        function calculateTotals(){
            let total = 0;
            document.querySelectorAll('#bill-table .amount').forEach(f => total += parseFloat(f.innerText) || 0);
            document.getElementById('grand-total').innerText = total.toFixed(2);
            let advance = parseFloat(document.getElementById('advance').value) || 0;
            document.getElementById('due').innerText = (total - advance).toFixed(2);
        }

        function addRow(){
            let tableBody = document.querySelector('#bill-table tbody');
            let newRow = tableBody.insertRow();
            newRow.innerHTML = `<td></td><td><input type="text" class="product-name" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£" oninput="autoResizeDescriptionWidth(this)"></td><td><input type="number" class="quantity" value="1" min="1" oninput="calculateRow(this); autoResizeInputWidth(this);"></td><td><input type="number" class="price" value="0" min="0" oninput="calculateRow(this); autoResizeInputWidth(this);"></td><td class="amount">0.00</td><td><button class="btn btn-remove" onclick="removeRow(this)">üóëÔ∏è</button></td>`;
            updateSerialNumbers();
            
            autoResizeDescriptionWidth(newRow.querySelector('.product-name'));
            autoResizeInputWidth(newRow.querySelector('.quantity'));
            autoResizeInputWidth(newRow.querySelector('.price'));
        }
        
        function removeRow(btn){
            if(document.querySelectorAll('#bill-table tbody tr').length > 1) {
                btn.closest('tr').remove();
                calculateTotals();
                updateSerialNumbers();
            } else { alert("‡¶∂‡ßá‡¶∑ ‡¶∏‡¶æ‡¶∞‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßã‡¶õ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§"); }
        }
        
        function collectMemoData(){
            let items = [];
            document.querySelectorAll('#bill-table tbody tr').forEach(row => {
                items.push({
                    name: row.querySelector('.product-name').value,
                    quantity: row.querySelector('.quantity').value,
                    price: row.querySelector('.price').value,
                    amount: row.querySelector('.amount').innerText
                });
            });
            return {
                memoNo: document.getElementById('memo-no').value, customerName: document.getElementById('customer-name').value,
                customerAddress: document.getElementById('customer-address').value, transactionDate: document.getElementById('transaction-date').value,
                deliveryDate: document.getElementById('delivery-date').value, advance: document.getElementById('advance').value,
                items: items, grandTotal: document.getElementById('grand-total').innerText,
                due: document.getElementById('due').innerText, timestamp: Date.now(), shopId: selectedShopId
            };
        }
        
        async function saveBillToHistory(){
            if (!currentUserId) return false;
            const memo = collectMemoData();
            if (!memo.customerName && !memo.memoNo) { alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Ç ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§'); return false; }
            if (!memo.transactionDate) { alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'); return false; }
            if (!memo.shopId) { alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'); return false; }
            
            try {
                await database.ref(`users/${currentUserId}/memos/${memo.transactionDate}`).push(memo);
                return true; 
            } catch (error) { alert('‡¶Æ‡ßá‡¶Æ‡ßã ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§'); return false; }
        }
        
        async function updateBillInHistory(){
            if(!currentlyEditing || !currentUserId) return false;
            const memo = collectMemoData();
            if(!memo.transactionDate) { alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'); return false; }
            
            try {
                if(currentlyEditing.date === memo.transactionDate) {
                    await database.ref(`users/${currentUserId}/memos/${currentlyEditing.date}/${currentlyEditing.key}`).update(memo);
                } else {
                    const updates = {};
                    updates[`users/${currentUserId}/memos/${currentlyEditing.date}/${currentlyEditing.key}`] = null;
                    updates[`users/${currentUserId}/memos/${memo.transactionDate}/${currentlyEditing.key}`] = memo;
                    await database.ref().update(updates);
                }
                return true;
            } catch (error) { alert('‡¶Æ‡ßá‡¶Æ‡ßã ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§'); return false; }
        }

        let historyView = 'dates', selectedHistoryDate = null;
        function displayHistory(){
            if (historyView === 'dates') displayDateList();
            else if (historyView === 'memos' && selectedHistoryDate) displayMemosForDate(selectedHistoryDate);
        }
        function viewMemosForDate(date) { historyView = 'memos'; selectedHistoryDate = date; displayHistory(); }

        function displayDateList(){
            if (!currentUserId) return;
            const list = document.getElementById('history-list');
            document.getElementById('history-page-title').innerText = '‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ';
            
            const memosRef = database.ref(`users/${currentUserId}/memos`).orderByKey();
            memosRef.on('value', (snapshot) => {
                list.innerHTML = '';
                if (!snapshot.exists()) {
                    list.innerHTML = `<div class="empty-state-container"><h2 class="empty-state-title">‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡ßá‡¶á!</h2></div>`; return;
                }
                
                Object.keys(snapshot.val()).reverse().forEach(date => {
                    const memosOnDate = snapshot.child(date).val();
                    let count = 0, total = 0;
                    for (const key in memosOnDate) {
                        const memo = memosOnDate[key];
                        if (selectedShopId && memo.shopId !== selectedShopId) continue;
                        count++; total += parseFloat(memo.grandTotal || 0);
                    }
                    if (count === 0) return;
                    
                    const fDate = new Date(date).toLocaleDateString('bn-BD', { year: 'numeric', month: 'long', day: 'numeric' });
                    const item = document.createElement('li');
                    item.className = 'date-history-item';
                    item.onclick = () => viewMemosForDate(date);
                    item.innerHTML = `<div><div style="font-weight: 600;">üóìÔ∏è ${fDate}</div><div style="font-size: 14px; color: var(--text-light)">üìù ${count} ‡¶ü‡¶ø ‡¶Æ‡ßá‡¶Æ‡ßã</div></div><div style="font-weight: 600;">‡ß≥ ${total.toFixed(2)}</div>`;
                    list.appendChild(item);
                });
            });
        }
        
        function displayMemosForDate(date){
            if (!currentUserId) return;
            const list = document.getElementById('history-list');
            const title = document.getElementById('history-page-title');
            const fDate = new Date(date).toLocaleDateString('bn-BD', { year: 'numeric', month: 'long', day: 'numeric' });
            title.innerHTML = `<a href="#" id="back-to-dates" style="font-size:16px; color: var(--primary-blue); text-decoration: none;">&#8592; ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</a> | ${fDate}`;

            const memosRef = database.ref(`users/${currentUserId}/memos/${date}`).orderByChild('timestamp');
            memosRef.on('value', (snapshot) => {
                list.innerHTML = '';
                if (!snapshot.exists()){ list.innerHTML = '<li>‡¶è‡¶á ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</li>'; return; }
                
                let memos = [];
                snapshot.forEach(child => {
                    const memo = child.val();
                    if(!selectedShopId || memo.shopId === selectedShopId) memos.push({ key: child.key, ...memo });
                });
                
                memos.reverse().forEach(memo => {
                    const item = document.createElement('li');
                    item.className = 'memo-list-item';
                    item.innerHTML = `
                        <span><strong>${memo.memoNo || 'N/A'}</strong> - ${memo.customerName || 'N/A'} (‡¶Æ‡ßã‡¶ü: ‡ß≥ ${parseFloat(memo.grandTotal || 0).toLocaleString('bn-BD')})</span>
                        <div class="controls">
                            <button class="btn btn-add" onclick="viewMemoFromHistory('${memo.key}','${date}')">‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                            <button class="btn" style="background:#f59e0b; color: white;" onclick="loadMemoFromHistory('${memo.key}','${date}')">‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</button>
                            <button class="btn btn-delete" onclick="deleteMemoFromHistory('${memo.key}','${date}')">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                        </div>`;
                    list.appendChild(item);
                });
                
                document.getElementById('back-to-dates').onclick = (e) => {
                    e.preventDefault(); historyView = 'dates'; selectedHistoryDate = null; displayHistory();
                };
            });
        }
        
        async function deleteMemoFromHistory(key, date){
            if (currentUserId && confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶á ‡¶Æ‡ßá‡¶Æ‡ßã‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                await database.ref(`users/${currentUserId}/memos/${date}/${key}`).remove().catch(e => alert('‡¶Æ‡ßá‡¶Æ‡ßã ‡¶Æ‡ßã‡¶õ‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§'));
            }
        }
        
        async function loadMemoFromHistory(key, date){
            if (!currentUserId) return;
            const snapshot = await database.ref(`users/${currentUserId}/memos/${date}/${key}`).once('value');
            const memo = snapshot.val();
            if (!memo) { alert('‡¶Æ‡ßá‡¶Æ‡ßã‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§'); return; }
            
            document.getElementById('memo-no').value = memo.memoNo || '';
            document.getElementById('customer-name').value = memo.customerName || '';
            document.getElementById('customer-address').value = memo.customerAddress || '';
            document.getElementById('transaction-date').value = memo.transactionDate || '';
            document.getElementById('delivery-date').value = memo.deliveryDate || '';
            document.getElementById('advance').value = memo.advance || 0;

            selectedShopId = memo.shopId;
            updateCustomDropdowns();
            
            const tableBody = document.querySelector('#bill-table tbody');
            tableBody.innerHTML = '';
            (memo.items || []).forEach(item => {
                let newRow = tableBody.insertRow();
                newRow.innerHTML = `<td></td><td><input type="text" class="product-name" value="${item.name||''}" oninput="autoResizeDescriptionWidth(this)"></td><td><input type="number" class="quantity" value="${item.quantity||1}" oninput="calculateRow(this); autoResizeInputWidth(this);"></td><td><input type="number" class="price" value="${item.price||0}" oninput="calculateRow(this); autoResizeInputWidth(this);"></td><td class="amount">${item.amount||'0.00'}</td><td><button class="btn btn-remove" onclick="removeRow(this)">üóëÔ∏è</button></td>`;
            });
            if ((memo.items || []).length === 0) addRow();
            
            document.querySelectorAll('#bill-table tbody .product-name').forEach(el => autoResizeDescriptionWidth(el));
            document.querySelectorAll('#bill-table tbody .quantity').forEach(el => autoResizeInputWidth(el));
            document.querySelectorAll('#bill-table tbody .price').forEach(el => autoResizeInputWidth(el));

            updateSerialNumbers(); calculateTotals();
            currentlyEditing = {key: key, date: date};
            document.getElementById('print-save-btn').innerText = '‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â';
            showMemoPage();
        }
        
        function numberToWordsBengali(num){ const s=['','‡¶è‡¶ï','‡¶¶‡ßÅ‡¶á','‡¶§‡¶ø‡¶®','‡¶ö‡¶æ‡¶∞','‡¶™‡¶æ‡¶Å‡¶ö','‡¶õ‡ßü','‡¶∏‡¶æ‡¶§','‡¶Ü‡¶ü','‡¶®‡ßü'],t=['‡¶¶‡¶∂','‡¶è‡¶ó‡¶æ‡¶∞‡ßã','‡¶¨‡¶æ‡¶∞‡ßã','‡¶§‡ßá‡¶∞‡ßã','‡¶ö‡ßã‡¶¶‡ßç‡¶¶','‡¶™‡¶®‡ßá‡¶∞‡ßã','‡¶∑‡ßã‡¶≤','‡¶∏‡¶§‡ßá‡¶∞‡ßã','‡¶Ü‡¶†‡¶æ‡¶∞‡ßã','‡¶â‡¶®‡¶ø‡¶∂'],d=['','','‡¶¨‡¶ø‡¶∂','‡¶§‡ßç‡¶∞‡¶ø‡¶∂','‡¶ö‡¶≤‡ßç‡¶≤‡¶ø‡¶∂','‡¶™‡¶û‡ßç‡¶ö‡¶æ‡¶∂','‡¶∑‡¶æ‡¶ü','‡¶∏‡¶§‡ßç‡¶§‡¶∞','‡¶Ü‡¶∂‡¶ø','‡¶®‡¶¨‡ßç‡¶¨‡¶á'],p=['',' ‡¶π‡¶æ‡¶ú‡¶æ‡¶∞',' ‡¶≤‡¶ï‡ßç‡¶∑',' ‡¶ï‡ßã‡¶ü‡¶ø'];function c(n){if(n<10)return s[n];if(n<20)return t[n-10];if(n<100)return d[Math.floor(n/10)]+(n%10!==0?' '+s[n%10]:'');if(n<1000)return s[Math.floor(n/100)]+' ‡¶∂‡¶§'+(n%100!==0?' '+c(n%100):'');return c(Math.floor(n/1000))+' ‡¶π‡¶æ‡¶ú‡¶æ‡¶∞'+(n%1000!==0?' '+c(n%1000):'')}if(num===0)return'‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø';let w='',i=0;while(num>0){let h=i===0?num%1000:num%100;if(h>0)w=c(h)+p[i]+' '+w;num=i===0?Math.floor(num/1000):Math.floor(num/100);i++}return w.trim()}
        
        function generatePrintContent(memoData) {
            const staticShopInfo = {
                name: "‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶ø‡¶ï ‡¶è‡¶®‡ßç‡¶° ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏",
                proprietor: "‡¶™‡ßç‡¶∞‡ßã‡¶É ‡¶Æ‡ßã‡¶É ‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤‡ßç‡¶≤‡¶æ‡¶π ‡¶Æ‡ßã‡¶≤‡ßç‡¶≤‡¶æ",
                details1: "‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï ‡¶ì ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶∏‡ßÅ‡¶≤‡¶≠ ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßá‡¶∞‡¶æ‡¶Æ‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡•§",
                contact: "‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡¶É ‡ß¶‡ßß‡ß©‡ß®‡ß¨-‡ßß‡ß≠‡ß¶‡ß≠‡ß≠‡ß≠",
                logoUrl: "https://i.ibb.co.com/B9LFnxY/20251109-143256.png"
            };

            const selectedShop = memoData.shopId && shops[memoData.shopId] ? shops[memoData.shopId] : null;
            
            const { memoNo, customerName, customerAddress, transactionDate, deliveryDate, items, grandTotal, advance, due } = memoData;
            const formattedTransactionDate = transactionDate ? new Date(transactionDate).toLocaleDateString('bn-BD') : 'N/A';
            const formattedDeliveryDate = deliveryDate ? new Date(deliveryDate).toLocaleDateString('bn-BD') : 'N/A';
            const amountInWords = numberToWordsBengali(Math.round(grandTotal));

            let tableRows = '';
            items.forEach((item, index) => {
                const pName = (item.name || '').replace(/\n/g, '<br>');
                tableRows += `<tr><td style="text-align:center;">${index + 1}</td><td>${pName}</td><td style="text-align:right;">${item.quantity || 1}</td><td style="text-align:right;">${(parseFloat(item.price || 0)).toFixed(2)}</td><td style="text-align:right;">${(parseFloat(item.amount || 0)).toFixed(2)}</td></tr>`;
            });

            let selectedShopHtml = '';
            if (selectedShop) {
                selectedShopHtml = `
                    <div class="selected-shop-info" style="margin-top: 15px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8faff;">
                        <h3 style="text-align: center; color: #0052D4; margin-top: 0; border-bottom: 1px solid #e2e8f0; padding-bottom: 6px; margin-bottom: 8px; font-size: 11px;">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¶‡ßã‡¶ï‡¶æ‡¶®</h3>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="${selectedShop.logoUrl}" alt="Shop Logo" style="height: 40px; border-radius: 6px;">
                            <div>
                                <p style="font-size: 12px; font-weight: 600; margin: 0;">${selectedShop.name}</p>
                                <p style="font-size: 10px; color: #64748B; margin: 2px 0;">${selectedShop.proprietor}</p>
                                <p style="font-size: 10px; color: #64748B; margin: 2px 0;">${selectedShop.contact}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `<html><head><title>Memo - ${customerName}</title><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"><style>
            body{font-family:'Poppins',sans-serif;margin:0;padding:5px;background-color:#f9fafb;color:#1e293b;font-size:10px; min-width: 320px;}
            .memo-container{max-width:400px;margin:5px auto;background:#fff;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.05);overflow:hidden;border:1px solid #e2e8f0}
            .memo-header {
                text-align: center; position: relative; overflow: hidden;
                background: #fff; padding: 20px 15px 15px 15px;
            }
            .memo-header::before {
                content: ''; position: absolute; top: 0; left: 0; right: 0; height: 100px; z-index: 0;
                background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 500 100' preserveAspectRatio='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M-5,35 C150,120 350,-30 505,50 L500,-5 L-5,-5 Z' style='stroke: none; fill: %23E9F2FF;'%3e%3c/path%3e%3cpath d='M-5,25 C100,70 200,20 300,40 C400,60 450,30 505,35 L500,-5 L-5,-5 Z' style='stroke: none; fill: %23D4E5FF; opacity: 0.8;'%3e%3c/path%3e%3cpath d='M30,80 a20,20 0 1,0 40,0 a20,20 0 1,0 -40,0' style='stroke: %23C0D8FF; stroke-width: 4; fill: none; opacity: 0.7;' /%3e %3ccircle cx='450' cy='40' r='12' style='fill: %23C0D8FF;' /%3e%3c/svg%3e");
                background-repeat: no-repeat; background-size: cover; background-position: center top;
            }
            .header-content { position: relative; z-index: 1; }
            .shop-logo {
                height: 40px; border-radius: 8px; margin-bottom: 5px;
                border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            .shop-name { font-size: 16px; font-weight: 700; color: #0052D4; margin: 0; }
            .shop-details { font-size: 9px; color: #4A90E2; margin: 2px 0; }
            .customer-info-section{display:grid;grid-template-columns:1fr 1fr;gap:5px;padding:10px;border-bottom:1px solid #e2e8f0}
            .info-field{display:flex;align-items:stretch;border-radius:4px;overflow:hidden;border:1px solid #e2e8f0;background:#f8faff}
            .info-field span{font-weight:600;padding:4px 6px;color:white;background-color:#4A90E2;display:flex;align-items:center;white-space:nowrap}
            .info-field p{margin:0;padding:4px 6px;width:100%; word-break: break-word;}
            .info-field.full-width{grid-column:1/-1}
            .memo-body{padding:10px}
            .products-table{width:100%;border-collapse:collapse;border-radius:6px;overflow:hidden; table-layout: fixed;}
            
            .products-table th, .products-table td {
                padding:5px 6px; text-align:left; border:1px solid #e2e8f0;
                word-wrap:break-word; overflow-wrap: break-word; vertical-align: middle; white-space: nowrap;
            }
            .products-table th:nth-child(2), .products-table td:nth-child(2) {
                white-space: normal;
            }
            .products-table th {
                background-color:#4A90E2; color:#fff; font-size:10px;
                text-transform:uppercase; font-weight:600;
            }

            .products-table tbody tr:nth-child(even){background-color:#f8faff}
            .memo-footer{padding:10px;display:flex;justify-content:space-between;align-items:flex-start;background-color:#f8faff;border-top:1px solid #e2e8f0}
            .notes{width:60%}.notes p{font-size:9px;color:#64748B;margin-top:0}.notes b{color:#1E293B}
            .totals-section{width:38%}
            .totals-table{width:100%;border-collapse:collapse}
            .totals-table td{padding:4px;font-size:10px;border-bottom:1px solid #e2e8f0}
            .totals-table tr:last-child td{border-bottom:none}
            .totals-table .label{color:#64748B}
            .totals-table .value{text-align:right;font-weight:700;color:#1E293B}
            .totals-table tr.due .value{font-size:12px;color:#0052D4;}
            .signature-section{display:flex;justify-content:space-between;margin-top:20px;padding:0 15px}
            .signature-line{border-top:1px dotted #64748B;width:120px;text-align:center;padding-top:4px;font-size:10px;font-weight:600}
            .final-note{text-align:center;margin-top:15px;font-size:9px;color:#64748B;padding:10px;border-top:1px solid #e2e8f0}
            @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
            </style></head>
                <body><div class="memo-container"><div class="memo-header"><div class="header-content"><img src="${staticShopInfo.logoUrl}" alt="Logo" class="shop-logo"><h1 class="shop-name">${staticShopInfo.name}</h1><p class="shop-details">${staticShopInfo.proprietor}</p><p class="shop-details">${staticShopInfo.details1}</p><p class="shop-details">${staticShopInfo.contact}</p></div></div><div class="customer-info-section"><div class="info-field"><span>‡¶®‡¶æ‡¶Æ‡¶É</span><p>${customerName}</p></div><div class="info-field"><span>‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Ç:</span><p>${memoNo}</p></div><div class="info-field full-width"><span>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ‡¶É</span><p>${customerAddress}</p></div><div class="info-field"><span>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡¶É</span><p>${formattedTransactionDate}</p></div><div class="info-field"><span>‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡¶É</span><p>${formattedDeliveryDate}</p></div></div><div class="memo-body"><table class="products-table"><thead><tr><th style="width:8%;text-align:center;">‡¶®‡¶Ç</th><th style="width:42%;">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th style="width:15%;text-align:right;">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th><th style="width:15%;text-align:right;">‡¶¶‡¶∞</th><th style="width:20%;text-align:right;">‡¶ü‡¶æ‡¶ï‡¶æ</th></tr></thead><tbody>${tableRows}</tbody></table> ${selectedShopHtml}</div><div class="memo-footer"><div class="notes"><p><b>‡¶ï‡¶•‡¶æ‡ßü‡¶É</b> ${amountInWords} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡•§</p></div><div class="totals-section"><table class="totals-table"><tbody><tr><td class="label">‡¶Æ‡ßã‡¶ü</td><td class="value">${parseFloat(grandTotal).toFixed(2)}</td></tr><tr><td class="label">‡¶Ö‡¶ó‡ßç‡¶∞‡¶ø‡¶Æ</td><td class="value">${parseFloat(advance).toFixed(2)}</td></tr><tr class="due"><td class="label"><strong>‡¶¨‡¶æ‡¶ï‡¶ø</strong></td><td class="value"><strong>${parseFloat(due).toFixed(2)}</strong></td></tr></tbody></table></div></div><div class="signature-section"><div class="signature-line">‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</div><div class="signature-line">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶§‡¶æ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</div></div><div class="final-note">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶§ ‡¶Æ‡¶æ‡¶≤ ‡¶´‡ßá‡¶∞‡¶§ ‡¶®‡ßá‡ßü‡¶æ ‡¶π‡ßü ‡¶®‡¶æ‡•§ ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§</div></div></body></html>`;
        }


        function executePrint(html) {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none'; document.body.appendChild(iframe);
            iframe.contentDocument.write(html); iframe.contentDocument.close();
            iframe.contentWindow.focus();
            setTimeout(() => { iframe.contentWindow.print(); document.body.removeChild(iframe); }, 500);
        }

        function showMemoPreview(memoData, backPage) {
            const content = generatePrintContent(memoData);
            previewPage.innerHTML = `<div class="container"><div class="glass-card"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><button class="btn" id="preview-back-btn" style="background: #f0f8ff; color: #007BFF;">&larr; ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button><button class="btn btn-add" id="preview-print-btn">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü üñ®Ô∏è</button></div><div id="memo-content-for-print">${content}</div></div></div>`;
            
            homePage.style.display = 'none'; mainContent.style.display = 'none'; historyPage.style.display = 'none'; shopPage.style.display = 'none';
            previewPage.style.display = 'block'; window.scrollTo(0,0);

            document.getElementById('preview-print-btn').onclick = () => executePrint(document.getElementById('memo-content-for-print').innerHTML);
            document.getElementById('preview-back-btn').onclick = () => {
                if (backPage === 'history') showHistoryPage(true);
                else { resetForm(); showMemoPage(); }
            };
        }
        
        async function viewMemoFromHistory(key, date) {
            if (!currentUserId) return;
            const snapshot = await database.ref(`users/${currentUserId}/memos/${date}/${key}`).once('value');
            if (snapshot.exists()) showMemoPreview(snapshot.val(), 'history');
            else alert('‡¶Æ‡ßá‡¶Æ‡ßã‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§');
        }
        
        async function saveAndShowPreview(){
            const success = currentlyEditing ? await updateBillInHistory() : await saveBillToHistory();
            if(success){
                showMemoPreview(collectMemoData(), 'memo');
                resetForm();
            }
        }
        
        function resetForm(){
            ['memo-no', 'customer-name', 'customer-address'].forEach(id => document.getElementById(id).value = '');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transaction-date').value = today;
            document.getElementById('delivery-date').value = today;
            document.getElementById('advance').value = 0;
            document.querySelector('#bill-table tbody').innerHTML = '';
            addRow(); calculateTotals();
            currentlyEditing = null;
            document.getElementById('print-save-btn').innerText = '‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â';
            closeNav();
        }

        // --- Event Listeners ---
        ['side-home-btn', 'bottom-nav-home'].forEach(id => document.getElementById(id).onclick = (e) => { e.preventDefault(); showHomeDashboard(); closeNav(); });
        ['side-new-memo-btn', 'bottom-nav-memo', 'fab-add-memo'].forEach(id => document.getElementById(id).onclick = (e) => { e.preventDefault(); resetForm(); showMemoPage(); closeNav(); });
        ['side-show-history-btn', 'bottom-nav-history'].forEach(id => document.getElementById(id).onclick = (e) => { e.preventDefault(); showHistoryPage(true); closeNav(); });
        ['side-shop-btn', 'bottom-nav-shop'].forEach(id => document.getElementById(id).onclick = (e) => { e.preventDefault(); showShopPage(); closeNav(); });
        document.getElementById('side-privacy-btn').onclick = () => { document.getElementById('privacyModal').style.display = 'block'; closeNav(); };
        document.getElementById('side-logout-btn').onclick = () => { handleSignOut(); closeNav(); };
        
        document.getElementById('shop-edit-modal-close-btn').onclick = () => document.getElementById('shopEditModal').style.display = "none";
        document.getElementById('privacy-modal-close-btn').onclick = () => document.getElementById('privacyModal').style.display = "none";
        
        document.getElementById('save-shop-info-btn').onclick = () => {
            if (!currentUserId) return;
            const shopInfo = { name: document.getElementById('shop-name-input').value, proprietor: document.getElementById('proprietor-name-input').value, details1: document.getElementById('shop-details1-input').value, contact: document.getElementById('shop-contact-input').value, logoUrl: document.getElementById('shop-logo-input').value };
            const shopId = document.getElementById('save-shop-info-btn').getAttribute('data-shop-id');
            const dbRef = database.ref(`users/${currentUserId}/shops`);
            
            const promise = shopId ? dbRef.child(shopId).update(shopInfo) : dbRef.push(shopInfo);
            promise.then(() => {
                alert(shopId ? '‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!' : '‡¶®‡¶§‡ßÅ‡¶® ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
                document.getElementById('shopEditModal').style.display = 'none';
            }).catch(e => alert('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ' + e.message));
        };

        window.onclick = (event) => {
            if (event.target == document.getElementById('shopEditModal')) document.getElementById('shopEditModal').style.display = "none";
            if (event.target == document.getElementById('privacyModal')) document.getElementById('privacyModal').style.display = "none";
        };
    </script>
</body>
</html>
